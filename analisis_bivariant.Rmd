---
title: "Analisis Bivariant"
author: "Grup5-MD"
date: "2025-09-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


# Ajustar la ruta al dataset
# setwd("C:/Users/AtoshiiPC/Desktop/UNI/7E QUADRI/MD/BBDD")
dd <- read.csv("Filtered_dataset.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

# Función para convertir a factor variables de texto con pocas modalidades
# auto_factorize <- function(df, max_levels = 30) {
#   for (nm in names(df)) {
#     col <- df[[nm]]
#     if (is.character(col)) {
#       uniq <- length(unique(col[!is.na(col)]))
#       if (uniq <= max_levels) df[[nm]] <- factor(col)
#     }
#     if (is.logical(col)) df[[nm]] <- factor(col, levels = c(FALSE, TRUE))
#   }
#   df
# }
# dd <- auto_factorize(dd)

# esto es para cambiar el tipo de las categoricas
    
    dd$SEX <- factor(dd$SEX, 
              levels= c(0,1), 
              labels = c("Female", "Male"))
    dd$INF_ANAM <- factor(dd$INF_ANAM, 
              levels= c(0,1,2,3), 
              labels = c("zero", "one", "two", ">=three"))
    dd$STENOK_AN <- factor(dd$STENOK_AN, 
              levels= c(0,1,2,3,4,5,6), 
              labels = c("never", "last year", "one year ago", 
                         "two years ago", "three years ago", "4-5 years ago", ">=5 years ago"))
    dd$LET_IS <- factor(dd$LET_IS,                      
              levels= c(0,1,2,3,4,5,6,7), 
              labels = c("unknown (alive)" ,"cardiogenic shock","pulmonary edema",
                         "myocardial rupture","progress of congestive HF",
                         "thromboembolism", "asystole", "ventricular fibrillation"))
    dd$GB <- factor(dd$GB,                      
              levels= c(0,1,2,3), 
              labels = c("there is no EH","Stage 1","Stage 2","Stage 3"))
    dd$SIM_GIPERT <- factor(dd$SIM_GIPERT,                      
              levels= c(0,1), 
              labels = c("no", "yes"))
    dd$ZSN_A <- factor(dd$ZSN_A,
              ordered = TRUE,                           # EN R NO SE PUEDE HACER ORDEN PARCIAL! ASÍ QUE LO DEJAMOS ASÍ
              levels= c(0,1,2,3,4), 
              labels = c("there is no CHF",
                         "I stage",
                         "IIÐ stage (HF due to R VSD)",
                         "IIÐ stage (HF due to L VSD)",
                         "IIB stage (HF due to L and R VSD)"))
    dd$endocr_01 <- factor(dd$endocr_01,                      
              levels= c(0,1), 
              labels = c("no", "yes"))

n <- nrow(dd)
K <- ncol(dd)
names(dd)

# Paquete opcional
if (!requireNamespace("psych", quietly = TRUE)) {
  install.packages("psych", repos = "https://cloud.r-project.org/")
}
library(psych)

# Funciones auxiliares
is_numeric_var <- function(x) is.numeric(x) || is.integer(x)
is_categorical_var <- function(x) is.factor(x) || is.character(x) || is.logical(x)

# Lista de combinaciones de variables
vars <- names(dd)
combos <- combn(vars, 2, simplify = FALSE)
```

```{r echo=FALSE}
# Loop para análisis
for (pair in combos) {
  v1 <- pair[1]; v2 <- pair[2]
  x <- dd[[v1]]; y <- dd[[v2]]

  cat("\n##", v1, "vs", v2, "\n")

  if (is_numeric_var(x) && is_numeric_var(y)) {
    # NUMERIC vs NUMERIC
    old_par <- par(no.readonly = TRUE)
    par(mar = c(5, 4, 4, 2))
    
    plot(x, y, main = paste("Scatter:", v1, "vs", v2), 
         xlab = v1, ylab = v2)
    
    if (sum(!is.na(x) & !is.na(y)) > 2) {
      abline(lm(y ~ x), col="red", lwd=2)
      
      # Correlación adaptativa
      if (length(unique(x)) > 10 && length(unique(y)) > 10) {
        print(cor.test(x, y, method = "pearson"))
      } else {
        print(cor.test(x, y, method = "spearman"))
      }
    }
    
    par(old_par)

  } else if ((is_numeric_var(x) && is_categorical_var(y)) ||
           (is_categorical_var(x) && is_numeric_var(y))) {
  # NUMERIC vs CATEGORICAL
  if (is_numeric_var(x)) {
    num <- x; catvar <- factor(y)
    num_name <- v1; cat_name <- v2
  } else {
    num <- y; catvar <- factor(x)
    num_name <- v2; cat_name <- v1
  }
  old_par <- par(no.readonly = TRUE)
  
  max_label_length <- max(nchar(levels(catvar)))
  bottom_margin <- ifelse(max_label_length > 10, 12, 
                         ifelse(max_label_length > 6, 10, 8))
  
  par(mar = c(bottom_margin, 4, 4, 2))  # Margen inferior dinámico
  boxplot(num ~ catvar, 
          main = paste("Boxplot:", num_name, "by", cat_name),
          xlab = "",  # Eliminar label del eje X
          ylab = num_name,
          las = 2, cex.axis = 0.8)
  
  mtext(cat_name, side = 1, line = bottom_margin - 2)
  
  par(old_par)
    
    if (length(levels(catvar)) <= 10) {
      cats <- levels(catvar)
      old_par <- par(no.readonly = TRUE) 

      ncat <- length(cats)
      ncols <- ceiling(sqrt(ncat))
      nrows <- ceiling(ncat / ncols)

      par(mfrow = c(nrows, ncols), mar = c(4, 4, 4, 2))

      for (c in cats) {
        hist(num[catvar == c],
             main = paste(num_name, "for", c),
             xlab = num_name,
             cex.main = 0.8)
      }

      par(old_par)
    }
    
    print(psych::describeBy(num, group = catvar, mat = TRUE))

  } else if (is_categorical_var(x) && is_categorical_var(y)) {
    # CATEGORICAL vs CATEGORICAL
    ttab <- table(x, y, useNA = "ifany")
    
    old_par <- par(no.readonly = TRUE) 
    par(mar = c(10, 4, 4, 2)) 
    
    barplot(ttab, las = 2, cex.names = 0.7, beside = TRUE, 
            legend.text = TRUE, 
            main = paste("Barplot:", v1, "vs", v2))    
    
    par(old_par)
    
    print(ttab)
    if (all(dim(ttab) > 1)) {
      print(chisq.test(ttab))
    }
  }
}
```
